<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Scrum</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

		<link rel="icon" type="image/svg+xml" href="scrum.svg">

		<style>
			html { height:100%; }
			body { min-height: 100%; display: flex; flex-direction:  column; }
			main { flex-grow: 1; background-color: #eee;}
			html, body {
				font-family: 'Inter', sans-serif;
			}

			.container {
				max-width: 960px;
			}

			.fw-black {
				font-weight: 900;
			}

			.output > * {
				font-family: Calibri, sans-serif!important;
				font-size: 11pt!important;
				background-color: transparent!important;
			}

			main, main > * {
				transition: all ease-in-out 250ms;
			}

			.darkMode {
				background-color:  #121212;
				color: white;
			}

			.btn-link {
				color: black;
			}

			.darkMode input, .darkMode .modal-content, .darkMode input:focus, .darkMode textarea, .darkMode textarea:focus, .darkMode select, .darkMode .list-group-item {
				background-color:  #444;
				color: #eee;
			}

			.darkMode h2, .darkMode .text-muted, .darkMode .btn-link, .darkMode label, .darkMode .handle, .darkMode svg:not(.ignore-dark-mode) {
				color:  #eee!important;
			}

			[v-cloak] {
				display:  none!important;
			}

			.cursor-pointer {
				cursor: pointer;
			}

			.fs-small {
				font-size:  14px;
			}

			.text-shadow {
  				text-shadow: 0 0 7px #000;
			}

			code {
				background-color: #f520733d;
				border: 1px solid #f52073;
			}

			.spinner {
				animation: 1.5s ease-in-out infinite spinner;
			}

			@keyframes spinner { 
				from { transform: rotate(-10deg) scale(1); }
				50% { transform: rotate(15deg) scale(1.1); }
				to { transform: rotate(-10deg) scale(1); }
			}
		</style>
	</head>
	<body>
		<noscript>
			You are using an unsupported browser, please enable Javascript to use this application.
		</noscript>

		<main v-cloak id="app" class="h-100" :class="{ darkMode: !settings.lightMode }">
			<div class="border p-3 mb-3 output visually-hidden" ref="taskNotes" style="font-family: Calibri, sans-serif;">
				<strong>{{settings.name}}</strong><br />
				<strong>{{todaysDate}}</strong><br /><br />
				<strong>Capacity:</strong> <span style="text-transform:capitalize">{{settings.capacity}}</span><br />
				<template v-if="!blockedTasks.length"><br /></template>
				<template v-if="blockedTasks.length">
					<strong>Blocked on {{blockedTasks.length}} task(s)</strong><br /><br />
				</template>

				<template v-for="task in tasksWithDetails">
					<strong>Task:</strong> {{task.name}}<br />
					<template v-if="task.status.length"><strong>Status:</strong> {{task.status}}<br /></template>
					<strong>Blocked:</strong> {{(task.blocked) ? 'Yes' : 'No'}}<br /><br />
				</template>
			</div>
				
			<div class="container position-relative">
				<div class="position-absolute end-0 py-3">
					<div v-if="settings.lightMode">
						<svg @click="useLightMode(false)" class="text-dark cursor-pointer spinner" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="30px" viewBox="0 0 24 24" width="30px" fill="currentColor"><rect fill="none" height="24" width="24"/><path d="M11.01,3.05C6.51,3.54,3,7.36,3,12c0,4.97,4.03,9,9,9c4.63,0,8.45-3.5,8.95-8c0.09-0.79-0.78-1.42-1.54-0.95 c-0.84,0.54-1.84,0.85-2.91,0.85c-2.98,0-5.4-2.42-5.4-5.4c0-1.06,0.31-2.06,0.84-2.89C12.39,3.94,11.9,2.98,11.01,3.05z"/></svg>
					</div>
					
					<div v-if="!settings.lightMode">
						<svg @click="useLightMode(true)" class="cursor-pointer ignore-dark-mode text-warning spinner" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="30px" viewBox="0 0 24 24" width="30px" fill="currentColor"><rect fill="none" height="24" width="24"/><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41 l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg>
					</div>
				</div>

				<div v-if="migration.show" class="modal d-block">
				  <div class="modal-dialog modal-lg">
				    <div class="modal-content">
				      <div class="modal-header">
				        <h5 class="modal-title">Migrate to Scrum</h5>
				      </div>
				      <div class="modal-body">
				        <p>Use another Scrum tool? You might be able to move your data to Scrum.</p>

				        <p class="text-muted small">Select your existing scrum tool:</p>
				        <select class="form-select mb-3" v-model="migration.source" name="" id="">
				        	<option :value="null">Select a tool</option>
				        	<option value="scrumhelper">Scrum Helper</option>
				        </select>

				        <div v-if="migration.source">
			        		<p class="text-muted small">Run the following command in the browser developer console to generate the migration content.</p>
				        	<pre><code v-if="migration.source === 'scrumhelper'" class="d-block word-wrap p-2">console.log(localStorage.getItem("tasklistV2"));</code></pre>

				        	<p class="text-muted small">Paste the content of the output here:</p>
				       	 	<textarea v-model="migration.content" class="form-control" rows="5"></textarea>
				        </div>
				      </div>
				      <div class="modal-footer">
				        <button type="button" @click="migrate" class="btn btn-success btn-sm">Migrate</button>
				        <button type="button" @click="closeMigrateTool" class="btn btn-secondary btn-sm">Close</button>
				      </div>
				    </div>
				  </div>
				</div>

				<div class="py-5">
					<div class="text-center mb-5">
						<div class="mb-3">
							<svg class="ignore-dark-mode" xmlns="http://www.w3.org/2000/svg" height="72" viewBox="0 0 24 24" width="72" fill="#1f97d5"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 14H6v-2h2v2zm0-3H6V9h2v2zm0-3H6V6h2v2zm6 6h-3c-.55 0-1-.45-1-1s.45-1 1-1h3c.55 0 1 .45 1 1s-.45 1-1 1zm3-3h-6c-.55 0-1-.45-1-1s.45-1 1-1h6c.55 0 1 .45 1 1s-.45 1-1 1zm0-3h-6c-.55 0-1-.45-1-1s.45-1 1-1h6c.55 0 1 .45 1 1s-.45 1-1 1z"/></svg>
						</div>
						<h1 class="fw-black">Scrum</h1>
					</div>

					<div class="mb-4">
						<h2 class="text-muted fw-bold mb-3">Your Status</h2>

						<div class="row">
							<div class="col-md-6">
								<label for="personName" class="form-label">Your Name</label>
								<input @change="sync" type="text" v-model="settings.name" class="form-control" id="personName" placeholder="Joe Bloggs">
							</div>
							<div class="col-md-6">
							  	<label for="capcity" class="form-label">Your Capacity</label>
							  	<select @change="sync" v-model="settings.capacity" class="form-select" aria-label="Default select example">
								  	<option value="" selected disabled>Select Capacity</option>
								  	<option value="light" selected="">Light (&lt; 50% Capacity - &lt; 3 hours available)</option>
							        <option value="medium">Medium (&lt; 50-85% Capacity - 1-3 hours available)</option>
							        <option value="busy">Busy (&lt; 85-95% Capacity - &lt; 1 hours)</option>
							        <option value="full">Full (100% Capacity - No free capacity)</option>
							        <option value="overloaded">Overloaded (100% Capacity - Cannot meet current deadlines)</option>
								</select>
							</div>
						</div>						
					</div>

					<div v-if="tasksWithDetails.length" class="mb-4">
						<div class="alert alert-secondary alert-sm d-flex align-items-center justify-content-between" role="alert">
					  		<div>
				  				You've got {{tasksWithDetails.length}} tasks recorded, you can now copy the notes to use in Microsoft Teams.
					  		</div>
						  	<div>
						    	<button @click="copy" class="btn btn-secondary">Copy Notes</button>
						  	</div>
						</div>
					</div>
					
					<div v-if="selectedTask" class="border p-3 mb-4">
						<div>
							<h2 class="text-muted fw-bold"><template v-if="isCreating">New</template><template v-else>Edit</template> Task</h2>
						</div>

						<p class="text-muted small">For this task to be included in the notes, you must have both a Name and a Status.</p>

						<div>
							<div class="mb-3">
							  	<label for="taskName" class="form-label">Task Name</label>
							  	<input type="text" v-model="selectedTask.name" class="form-control" id="taskName" placeholder="Example Project or https://eu1.clarizen.com/Clarizen/Task/.....">
							</div>
							<div class="mb-3">
							  	<label for="taskStatus" class="form-label">Task Status</label>
							  	<textarea class="form-control" v-model="selectedTask.status" id="taskStatus" rows="3"></textarea>
							</div>
							<div class="mb-3">
							  	<div class="form-check form-switch">
								  	<input class="form-check-input" v-model="selectedTask.blocked" type="checkbox" role="switch" id="taskBlocked">
								  	<label class="form-check-label" for="taskBlocked">Blocked?</label>
								</div>
							</div>
						</div>

						<div>
							<button v-if="!isCreating" @click="remove(selectedTask)" class="btn btn-danger btn-sm">Delete Task</button>
							<button v-if="!isCreating" @click="close" class="btn btn-success btn-sm">Save Task</button>

							<button v-if="isCreating" @click="remove(selectedTask)" class="btn btn-secondary btn-sm">Cancel</button>
							<button v-if="isCreating" @click="close" class="btn btn-success btn-sm">Create Task</button>
						</div>
					</div>

					<div>
						<div class="mb-3 d-flex align-items-center justify-content-between">
							<h2 class="text-muted fw-bold mb-0">Your Tasks</h2>
							<button @click="create" class="btn btn-sm btn-primary">Add New</button>
						</div>
						<div>
							<div v-if="!tasks.length" class="border p-3">
								You have no tasks, create a new one to get started.
							</div>
							<draggable v-if="tasks.length" v-model="tasks" handle=".handle" class="list-group mb-3 border">
								<div v-for="(task, index) in tasks" :key="task.uid" class="list-group-item d-flex align-items-center justify-content-between lh-sm">
									<div class="d-flex justify-content-start">
										<div class="me-3 align-self-center">
											<div class="handle">
												<svg class="cursor-pointer" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 9H5c-.55 0-1 .45-1 1s.45 1 1 1h14c.55 0 1-.45 1-1s-.45-1-1-1zM5 15h14c.55 0 1-.45 1-1s-.45-1-1-1H5c-.55 0-1 .45-1 1s.45 1 1 1z"/></svg>
											</div>
										</div>
										<div>
											<h6 class="my-0">{{task.name || "Set a Task Name"}}</h6>
											<small v-if="task.status.length" class="text-muted">{{task.status || "Set a Task Status"}}</small>
										</div>
									</div>
									<div class="flex-shrink-0">
										<div class="d-flex align-items-center flex-grow-1">
											<span v-if="task.blocked" class="badge bg-danger me-2">Blocked</span>
											<span v-if="!task.blocked" class="badge bg-success me-2">Not Blocked</span>

											<div @click="edit(task)" class="me-2">
												<svg class="cursor-pointer" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 17.46v3.04c0 .28.22.5.5.5h3.04c.13 0 .26-.05.35-.15L17.81 9.94l-3.75-3.75L3.15 17.1c-.1.1-.15.22-.15.36zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
											</div>
											<div @click="remove(task)" class="">
												<svg class="cursor-pointer" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v10zM18 4h-2.5l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6c-.55 0-1 .45-1 1s.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z"/></svg>
											</div>	
										</div>
									</div>
								</div>
							</draggable>
						</div>
					</div>

					<div class="text-center my-5 fs-small">
						<p class="mb-2">Created with <span class="text-danger">♥</span> by Stuart</p>
						<button @click="migration.show = true" class="btn btn-link fs-small">Migrate to Scrum</button>						
						<button @click="clearAllTasks" class="btn btn-link fs-small">Clear All Tasks</button>						
						<button @click="clearAll" class="btn btn-link fs-small">Reset Everything</button>
					</div>
				</div>
			</div>
		</main>

		<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
		<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>

		<script>
			var app = new Vue({
				el: '#app',
				components: {
				    draggable: window['vuedraggable']
				},
				data: {
					isCreating: false,
					selectedTask: null,
					tasks: [],
					settings: {
						name: '',
						capacity: '',
						lightMode: true
					},
					migration: {
						show: false,
						source: null,
						content: ''
					}
				},
				mounted: function(){
					var tasks = this.fetchFromStorage("scrumTasks", JSON.stringify([]));
					this.tasks = JSON.parse(tasks);

					this.settings.lightMode = !(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);

					var settings = this.fetchFromStorage("scrumSettings", {});
					this.settings = Object.assign(this.settings, JSON.parse(settings));
				},
				watch: {
					tasks: function(){
						this.sync();
					}
				},
				computed: {
					tasksWithDetails: function(){
						return this.tasks.filter(function(task) { return task.name.trim().length });
					},
					blockedTasks: function(){
						return this.tasks.filter(function(task) { return task.blocked });
					},
					todaysDate: function(){
						var date = new Date();
						return ('0' + date.getDate()).slice(-2) + '/'
             					+ ('0' + (date.getMonth()+1)).slice(-2) + '/'
             					+ date.getFullYear();
					}
				},
				methods: {
					fetchFromStorage: function(key, defaultValue){
						var item = localStorage.getItem(key);
						return item || defaultValue;
					},
					useLightMode: function(status){
						this.settings.lightMode = status;
						this.sync();
					},
					sync: function() {
						localStorage.setItem('scrumTasks', JSON.stringify(this.tasks));
						localStorage.setItem('scrumSettings', JSON.stringify(this.settings));
					},
					copy: function() {
					    var range = document.createRange();
					    range.selectNode(this.$refs.taskNotes); 
					    window.getSelection().removeAllRanges(); 
					    window.getSelection().addRange(range);
					    document.execCommand("copy");
						window.getSelection().removeAllRanges();
					},
					create: function() {
						this.isCreating = true;
						var task = {
							uid: Date.now().toString(36) + Math.random().toString(36).substr(2),
							name: '',
							status: '',
							blocked: false
						};

						this.selectedTask = task;
						this.tasks.push(task);
					},
					edit: function(task){
						this.isCreating = false;
						this.selectedTask = task;
					},
					remove: function(task){
						if(this.selectedTask !== null && task.uid === this.selectedTask.uid){
							this.selectedTask = null;
						}

						this.tasks = this.tasks.filter(function(t) { return t.uid !== task.uid });
					},
					clearAllTasks: function(){
						this.tasks = [];
						this.sync();
					},
					clearAll: function(){
						this.settings.name = "";
						this.settings.capacity = "";
						this.clearAllTasks();
					},
					close: function(){
						this.selectedTask = null;
						this.isCreating = false;
						this.sync();
					},
					migrate: function(){
						try {
        					var parsedMigrateContent = JSON.parse(this.migration.content);

        					if(this.migration.source === "scrumhelper"){
        						this.tasks = parsedMigrateContent.tasklist.map(function(task){
        							return {
										uid: Date.now().toString(36) + Math.random().toString(36).substr(2),
										name: task.name,
										status: task.status,
										blocked: task.blocked === "Yes"
        							}
        						});

        						this.settings = {
									name: parsedMigrateContent.username,
									capacity: parsedMigrateContent.capacity.toLowerCase(),
									lightMode: parsedMigrateContent.theme !== "dark"
								}
        					}

        					this.sync();
							this.closeMigrateTool();
    					} catch(e) {
        					alert("Could not parse out the content, did you paste in the migration content correctly?");
    					}
					},
					closeMigrateTool: function(){
						this.migration = {
							show: false,
							source: null,
							content: ''
						};
					}
				}
			})
		</script>
	</body>
</html>